var gulp=require("gulp"),rename=require("gulp-rename"),uglify=require("gulp-uglify"),header=require("gulp-header"),concat=require("gulp-concat"),replace=require("gulp-replace"),fs=require("fs"),paths={componentsFile:"components.js",components:["components/**/*.js","!components/**/*.min.js"],main:["components/prism-core.js","components/prism-markup.js","components/prism-css.js","components/prism-clike.js","components/prism-javascript.js","plugins/file-highlight/prism-file-highlight.js"],plugins:["plugins/**/*.js","!plugins/**/*.min.js"],showLanguagePlugin:"plugins/show-language/prism-show-language.js",autoloaderPlugin:"plugins/autoloader/prism-autoloader.js"};gulp.task("components",function(){return gulp.src(paths.components).pipe(uglify()).pipe(rename({suffix:".min"})).pipe(gulp.dest("components"))}),gulp.task("build",function(){return gulp.src(paths.main).pipe(header("\n/* **********************************************\n     Begin <%= file.relative %>\n********************************************** */\n\n")).pipe(concat("prism.js")).pipe(gulp.dest("./"))}),gulp.task("plugins",["languages-plugins"],function(){return gulp.src(paths.plugins).pipe(uglify()).pipe(rename({suffix:".min"})).pipe(gulp.dest("plugins"))}),gulp.task("watch",function(){gulp.watch(paths.components,["components","build"]),gulp.watch(paths.plugins,["plugins","build"])}),gulp.task("languages-plugins",function(e){fs.readFile(paths.componentsFile,{encoding:"utf-8"},function(t,n){if(!t){n=n.replace(/^var\s+components\s*=\s*|;\s*$/g,"");try{n=JSON.parse(n);var r={},i={};for(var s in n.languages)if(s!=="meta"){var o=n.languages[s].displayTitle||n.languages[s].title,u=s.substring(0,1).toUpperCase()+s.substring(1);o!==u&&(r[s]=o),n.languages[s].require&&(i[s]=n.languages[s].require)}var a=JSON.stringify(r),f=JSON.stringify(i),l=[{plugin:paths.showLanguagePlugin,map:a},{plugin:paths.autoloaderPlugin,map:f}],c=0,h=l.length,p=function(){c++,c===h&&e&&e()};l.forEach(function(e){var t=gulp.src(e.plugin).pipe(replace(/\/\*languages_placeholder\[\*\/[\s\S]*?\/\*\]\*\//,"/*languages_placeholder[*/"+e.map+"/*]*/")).pipe(gulp.dest(e.plugin.substring(0,e.plugin.lastIndexOf("/"))));t.on("error",p),t.on("end",p)})}catch(d){e(d)}}else e(t)})}),gulp.task("default",["components","plugins","build"]);