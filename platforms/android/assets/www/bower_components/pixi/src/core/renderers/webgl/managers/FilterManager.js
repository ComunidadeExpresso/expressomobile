function FilterManager(e){WebGLManager.call(this,e),this.filterStack=[],this.filterStack.push({renderTarget:e.currentRenderTarget,filter:[],bounds:null}),this.texturePool=[],this.textureSize=new math.Rectangle(0,0,e.width,e.height),this.currentFrame=null}var WebGLManager=require("./WebGLManager"),RenderTarget=require("../utils/RenderTarget"),CONST=require("../../../const"),Quad=require("../utils/Quad"),math=require("../../../math");FilterManager.prototype=Object.create(WebGLManager.prototype),FilterManager.prototype.constructor=FilterManager,module.exports=FilterManager,FilterManager.prototype.onContextChange=function(){this.texturePool.length=0;var e=this.renderer.gl;this.quad=new Quad(e)},FilterManager.prototype.setFilterStack=function(e){this.filterStack=e},FilterManager.prototype.pushFilter=function(e,t){var n=e.filterArea?e.filterArea.clone():e.getBounds();n.x=n.x|0,n.y=n.y|0,n.width=n.width|0,n.height=n.height|0;var r=t[0].padding|0;n.x-=r,n.y-=r,n.width+=r*2,n.height+=r*2;if(this.renderer.currentRenderTarget.transform){var i=this.renderer.currentRenderTarget.transform;n.x+=i.tx,n.y+=i.ty,this.capFilterArea(n),n.x-=i.tx,n.y-=i.ty}else this.capFilterArea(n);if(n.width>0&&n.height>0){this.currentFrame=n;var s=this.getRenderTarget();this.renderer.setRenderTarget(s),s.clear(),this.filterStack.push({renderTarget:s,filter:t})}else this.filterStack.push({renderTarget:null,filter:t})},FilterManager.prototype.popFilter=function(){var e=this.filterStack.pop(),t=this.filterStack[this.filterStack.length-1],n=e.renderTarget;if(!e.renderTarget)return;var r=t.renderTarget,i=this.renderer.gl;this.currentFrame=n.frame,this.quad.map(this.textureSize,n.frame),i.bindBuffer(i.ARRAY_BUFFER,this.quad.vertexBuffer),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.quad.indexBuffer);var s=e.filter;i.vertexAttribPointer(this.renderer.shaderManager.defaultShader.attributes.aVertexPosition,2,i.FLOAT,!1,0,0),i.vertexAttribPointer(this.renderer.shaderManager.defaultShader.attributes.aTextureCoord,2,i.FLOAT,!1,0,32),i.vertexAttribPointer(this.renderer.shaderManager.defaultShader.attributes.aColor,4,i.FLOAT,!1,0,64),this.renderer.blendModeManager.setBlendMode(CONST.BLEND_MODES.NORMAL);if(s.length===1)s[0].uniforms.dimensions&&(s[0].uniforms.dimensions.value[0]=this.renderer.width,s[0].uniforms.dimensions.value[1]=this.renderer.height,s[0].uniforms.dimensions.value[2]=this.quad.vertices[0],s[0].uniforms.dimensions.value[3]=this.quad.vertices[5]),s[0].applyFilter(this.renderer,n,r),this.returnRenderTarget(n);else{var o=n,u=this.getRenderTarget(!0);for(var a=0;a<s.length-1;a++){var f=s[a];f.uniforms.dimensions&&(f.uniforms.dimensions.value[0]=this.renderer.width,f.uniforms.dimensions.value[1]=this.renderer.height,f.uniforms.dimensions.value[2]=this.quad.vertices[0],f.uniforms.dimensions.value[3]=this.quad.vertices[5]),f.applyFilter(this.renderer,o,u);var l=o;o=u,u=l}s[s.length-1].applyFilter(this.renderer,o,r),this.returnRenderTarget(o),this.returnRenderTarget(u)}return e.filter},FilterManager.prototype.getRenderTarget=function(e){var t=this.texturePool.pop()||new RenderTarget(this.renderer.gl,this.textureSize.width,this.textureSize.height,CONST.SCALE_MODES.LINEAR,this.renderer.resolution*CONST.FILTER_RESOLUTION);return t.frame=this.currentFrame,e&&t.clear(!0),t},FilterManager.prototype.returnRenderTarget=function(e){this.texturePool.push(e)},FilterManager.prototype.applyFilter=function(e,t,n,r){var i=this.renderer.gl;this.renderer.setRenderTarget(n),r&&n.clear(),this.renderer.shaderManager.setShader(e),e.uniforms.projectionMatrix.value=this.renderer.currentRenderTarget.projectionMatrix.toArray(!0),e.syncUniforms(),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,t.texture),i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,0),this.renderer.drawCount++},FilterManager.prototype.calculateMappedMatrix=function(e,t,n){var r=t.worldTransform.copy(math.Matrix.TEMP_MATRIX),i=t._texture.baseTexture,s=n.identity(),o=this.textureSize.height/this.textureSize.width;s.translate(e.x/this.textureSize.width,e.y/this.textureSize.height),s.scale(1,o);var u=this.textureSize.width/i.width,a=this.textureSize.height/i.height;return r.tx/=i.width*u,r.ty/=i.width*u,r.invert(),s.prepend(r),s.scale(1,1/o),s.scale(u,a),s.translate(t.anchor.x,t.anchor.y),s},FilterManager.prototype.capFilterArea=function(e){e.x<0&&(e.width+=e.x,e.x=0),e.y<0&&(e.height+=e.y,e.y=0),e.x+e.width>this.textureSize.width&&(e.width=this.textureSize.width-e.x),e.y+e.height>this.textureSize.height&&(e.height=this.textureSize.height-e.y)},FilterManager.prototype.resize=function(e,t){this.textureSize.width=e,this.textureSize.height=t;for(var n=0;n<this.texturePool.length;n++)this.texturePool[n].resize(e,t)},FilterManager.prototype.destroy=function(){this.quad.destroy(),WebGLManager.prototype.destroy.call(this),this.filterStack=null,this.offsetY=0;for(var e=0;e<this.texturePool.length;e++)this.texturePool[e].destroy();this.texturePool=null};