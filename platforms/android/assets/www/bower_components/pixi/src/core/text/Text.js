function Text(e,t,n){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.resolution=n||CONST.RESOLUTION,this._text=null,this._style=null;var r=Texture.fromCanvas(this.canvas);r.trim=new math.Rectangle,Sprite.call(this,r),this.text=e,this.style=t}var Sprite=require("../sprites/Sprite"),Texture=require("../textures/Texture"),math=require("../math"),utils=require("../utils"),CONST=require("../const");Text.prototype=Object.create(Sprite.prototype),Text.prototype.constructor=Text,module.exports=Text,Text.fontPropertiesCache={},Text.fontPropertiesCanvas=document.createElement("canvas"),Text.fontPropertiesContext=Text.fontPropertiesCanvas.getContext("2d"),Object.defineProperties(Text.prototype,{width:{get:function(){return this.dirty&&this.updateText(),this.scale.x*this._texture._frame.width},set:function(e){this.scale.x=e/this._texture._frame.width,this._width=e}},height:{get:function(){return this.dirty&&this.updateText(),this.scale.y*this._texture._frame.height},set:function(e){this.scale.y=e/this._texture._frame.height,this._height=e}},style:{get:function(){return this._style},set:function(e){e=e||{},typeof e.fill=="number"&&(e.fill=utils.hex2string(e.fill)),typeof e.stroke=="number"&&(e.stroke=utils.hex2string(e.stroke)),typeof e.dropShadowColor=="number"&&(e.dropShadowColor=utils.hex2string(e.dropShadowColor)),e.font=e.font||"bold 20pt Arial",e.fill=e.fill||"black",e.align=e.align||"left",e.stroke=e.stroke||"black",e.strokeThickness=e.strokeThickness||0,e.wordWrap=e.wordWrap||!1,e.wordWrapWidth=e.wordWrapWidth||100,e.dropShadow=e.dropShadow||!1,e.dropShadowColor=e.dropShadowColor||"#000000",e.dropShadowAngle=e.dropShadowAngle||Math.PI/6,e.dropShadowDistance=e.dropShadowDistance||5,e.padding=e.padding||0,e.textBaseline=e.textBaseline||"alphabetic",e.lineJoin=e.lineJoin||"miter",e.miterLimit=e.miterLimit||10,this._style=e,this.dirty=!0}},text:{get:function(){return this._text},set:function(e){e=e.toString()||" ";if(this._text===e)return;this._text=e,this.dirty=!0}}}),Text.prototype.updateText=function(){var e=this._style;this.context.font=e.font;var t=e.wordWrap?this.wordWrap(this._text):this._text,n=t.split(/(?:\r\n|\r|\n)/),r=new Array(n.length),i=0,s=this.determineFontProperties(e.font);for(var o=0;o<n.length;o++){var u=this.context.measureText(n[o]).width;r[o]=u,i=Math.max(i,u)}var a=i+e.strokeThickness;e.dropShadow&&(a+=e.dropShadowDistance),this.canvas.width=(a+this.context.lineWidth)*this.resolution;var f=this.style.lineHeight||s.fontSize+e.strokeThickness,l=f*n.length;e.dropShadow&&(l+=e.dropShadowDistance),this.canvas.height=(l+this._style.padding*2)*this.resolution,this.context.scale(this.resolution,this.resolution),navigator.isCocoonJS&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.font=e.font,this.context.strokeStyle=e.stroke,this.context.lineWidth=e.strokeThickness,this.context.textBaseline=e.textBaseline,this.context.lineJoin=e.lineJoin,this.context.miterLimit=e.miterLimit;var c,h;if(e.dropShadow){this.context.fillStyle=e.dropShadowColor;var p=Math.cos(e.dropShadowAngle)*e.dropShadowDistance,d=Math.sin(e.dropShadowAngle)*e.dropShadowDistance;for(o=0;o<n.length;o++)c=e.strokeThickness/2,h=e.strokeThickness/2+o*f+s.ascent,e.align==="right"?c+=i-r[o]:e.align==="center"&&(c+=(i-r[o])/2),e.fill&&this.context.fillText(n[o],c+p,h+d+this._style.padding)}this.context.fillStyle=e.fill;for(o=0;o<n.length;o++)c=e.strokeThickness/2,h=e.strokeThickness/2+o*f+s.ascent,e.align==="right"?c+=i-r[o]:e.align==="center"&&(c+=(i-r[o])/2),e.stroke&&e.strokeThickness&&this.context.strokeText(n[o],c,h+this._style.padding),e.fill&&this.context.fillText(n[o],c,h+this._style.padding);this.updateTexture()},Text.prototype.updateTexture=function(){var e=this._texture;e.baseTexture.hasLoaded=!0,e.baseTexture.resolution=this.resolution,e.baseTexture.width=this.canvas.width/this.resolution,e.baseTexture.height=this.canvas.height/this.resolution,e.crop.width=e._frame.width=this.canvas.width/this.resolution,e.crop.height=e._frame.height=this.canvas.height/this.resolution,e.trim.x=0,e.trim.y=-this._style.padding,e.trim.width=e._frame.width,e.trim.height=e._frame.height-this._style.padding*2,this._width=this.canvas.width/this.resolution,this._height=this.canvas.height/this.resolution,e.baseTexture.emit("update",e.baseTexture),this.dirty=!1},Text.prototype.renderWebGL=function(e){this.dirty&&this.updateText(),Sprite.prototype.renderWebGL.call(this,e)},Text.prototype._renderCanvas=function(e){this.dirty&&this.updateText(),Sprite.prototype._renderCanvas.call(this,e)},Text.prototype.determineFontProperties=function(e){var t=Text.fontPropertiesCache[e];if(!t){t={};var n=Text.fontPropertiesCanvas,r=Text.fontPropertiesContext;r.font=e;var i=Math.ceil(r.measureText("|MÉq").width),s=Math.ceil(r.measureText("M").width),o=2*s;s=s*1.4|0,n.width=i,n.height=o,r.fillStyle="#f00",r.fillRect(0,0,i,o),r.font=e,r.textBaseline="alphabetic",r.fillStyle="#000",r.fillText("|MÉq",0,s);var u=r.getImageData(0,0,i,o).data,a=u.length,f=i*4,l,c,h=0,p=!1;for(l=0;l<s;l++){for(c=0;c<f;c+=4)if(u[h+c]!==255){p=!0;break}if(!!p)break;h+=f}t.ascent=s-l,h=a-f,p=!1;for(l=o;l>s;l--){for(c=0;c<f;c+=4)if(u[h+c]!==255){p=!0;break}if(!!p)break;h-=f}t.descent=l-s,t.fontSize=t.ascent+t.descent,Text.fontPropertiesCache[e]=t}return t},Text.prototype.wordWrap=function(e){var t="",n=e.split("\n"),r=this._style.wordWrapWidth;for(var i=0;i<n.length;i++){var s=r,o=n[i].split(" ");for(var u=0;u<o.length;u++){var a=this.context.measureText(o[u]).width,f=a+this.context.measureText(" ").width;u===0||f>s?(u>0&&(t+="\n"),t+=o[u],s=r-a):(s-=f,t+=" "+o[u])}i<n.length-1&&(t+="\n")}return t},Text.prototype.getBounds=function(e){return this.dirty&&this.updateText(),Sprite.prototype.getBounds.call(this,e)},Text.prototype.destroy=function(e){this.context=null,this.canvas=null,this._style=null,this._texture.destroy(e===undefined?!0:e)};