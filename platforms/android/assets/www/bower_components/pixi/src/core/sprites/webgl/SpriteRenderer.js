function SpriteRenderer(e){ObjectRenderer.call(this,e),this.vertSize=5,this.vertByteSize=this.vertSize*4,this.size=CONST.SPRITE_BATCH_SIZE;var t=this.size*4*this.vertByteSize,n=this.size*6;this.vertices=new ArrayBuffer(t),this.positions=new Float32Array(this.vertices),this.colors=new Uint32Array(this.vertices),this.indices=new Uint16Array(n);for(var r=0,i=0;r<n;r+=6,i+=4)this.indices[r+0]=i+0,this.indices[r+1]=i+1,this.indices[r+2]=i+2,this.indices[r+3]=i+0,this.indices[r+4]=i+2,this.indices[r+5]=i+3;this.currentBatchSize=0,this.sprites=[],this.shader=null}var ObjectRenderer=require("../../renderers/webgl/utils/ObjectRenderer"),WebGLRenderer=require("../../renderers/webgl/WebGLRenderer"),CONST=require("../../const");SpriteRenderer.prototype=Object.create(ObjectRenderer.prototype),SpriteRenderer.prototype.constructor=SpriteRenderer,module.exports=SpriteRenderer,WebGLRenderer.registerPlugin("sprite",SpriteRenderer),SpriteRenderer.prototype.onContextChange=function(){var e=this.renderer.gl;this.shader=this.renderer.shaderManager.defaultShader,this.vertexBuffer=e.createBuffer(),this.indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.indices,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,this.vertices,e.DYNAMIC_DRAW),this.currentBlendMode=99999},SpriteRenderer.prototype.render=function(e){var t=e._texture;this.currentBatchSize>=this.size&&this.flush();var n=t._uvs;if(!n)return;var r=e.anchor.x,i=e.anchor.y,s,o,u,a;if(t.trim&&e.tileScale===undefined){var f=t.trim;o=f.x-r*f.width,s=o+t.crop.width,a=f.y-i*f.height,u=a+t.crop.height}else s=t._frame.width*(1-r),o=t._frame.width*-r,u=t._frame.height*(1-i),a=t._frame.height*-i;var l=this.currentBatchSize*this.vertByteSize,c=e.worldTransform,h=c.a,p=c.b,d=c.c,v=c.d,m=c.tx,g=c.ty,y=this.colors,b=this.positions;this.renderer.roundPixels?(b[l]=h*o+d*a+m|0,b[l+1]=v*a+p*o+g|0,b[l+5]=h*s+d*a+m|0,b[l+6]=v*a+p*s+g|0,b[l+10]=h*s+d*u+m|0,b[l+11]=v*u+p*s+g|0,b[l+15]=h*o+d*u+m|0,b[l+16]=v*u+p*o+g|0):(b[l]=h*o+d*a+m,b[l+1]=v*a+p*o+g,b[l+5]=h*s+d*a+m,b[l+6]=v*a+p*s+g,b[l+10]=h*s+d*u+m,b[l+11]=v*u+p*s+g,b[l+15]=h*o+d*u+m,b[l+16]=v*u+p*o+g),b[l+2]=n.x0,b[l+3]=n.y0,b[l+7]=n.x1,b[l+8]=n.y1,b[l+12]=n.x2,b[l+13]=n.y2,b[l+17]=n.x3,b[l+18]=n.y3;var w=e.tint;y[l+4]=y[l+9]=y[l+14]=y[l+19]=(w>>16)+(w&65280)+((w&255)<<16)+(e.worldAlpha*255<<24),this.sprites[this.currentBatchSize++]=e},SpriteRenderer.prototype.flush=function(){if(this.currentBatchSize===0)return;var e=this.renderer.gl,t;if(this.currentBatchSize>this.size*.5)e.bufferSubData(e.ARRAY_BUFFER,0,this.vertices);else{var n=this.positions.subarray(0,this.currentBatchSize*this.vertByteSize);e.bufferSubData(e.ARRAY_BUFFER,0,n)}var r,i,s,o=0,u=0,a=null,f=this.renderer.blendModeManager.currentBlendMode,l=null,c=!1,h=!1,p;for(var d=0,v=this.currentBatchSize;d<v;d++){p=this.sprites[d],r=p._texture.baseTexture,i=p.blendMode,s=p.shader||this.shader,c=f!==i,h=l!==s;if(a!==r||c||h)this.renderBatch(a,o,u),u=d,o=0,a=r,c&&(f=i,this.renderer.blendModeManager.setBlendMode(f)),h&&(l=s,t=l.shaders?l.shaders[e.id]:l,t||(t=l.getShader(this.renderer)),this.renderer.shaderManager.setShader(t),t.uniforms.projectionMatrix.value=this.renderer.currentRenderTarget.projectionMatrix.toArray(!0),t.syncUniforms(),e.activeTexture(e.TEXTURE0));o++}this.renderBatch(a,o,u),this.currentBatchSize=0},SpriteRenderer.prototype.renderBatch=function(e,t,n){if(t===0)return;var r=this.renderer.gl;e._glTextures[r.id]?r.bindTexture(r.TEXTURE_2D,e._glTextures[r.id]):this.renderer.updateTexture(e),r.drawElements(r.TRIANGLES,t*6,r.UNSIGNED_SHORT,n*6*2),this.renderer.drawCount++},SpriteRenderer.prototype.start=function(){var e=this.renderer.gl;e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer);var t=this.vertByteSize;e.vertexAttribPointer(this.shader.attributes.aVertexPosition,2,e.FLOAT,!1,t,0),e.vertexAttribPointer(this.shader.attributes.aTextureCoord,2,e.FLOAT,!1,t,8),e.vertexAttribPointer(this.shader.attributes.aColor,4,e.UNSIGNED_BYTE,!0,t,16)},SpriteRenderer.prototype.destroy=function(){this.renderer.gl.deleteBuffer(this.vertexBuffer),this.renderer.gl.deleteBuffer(this.indexBuffer),ObjectRenderer.prototype.destroy.call(this),this.shader.destroy(),this.renderer=null,this.vertices=null,this.positions=null,this.colors=null,this.indices=null,this.vertexBuffer=null,this.indexBuffer=null,this.sprites=null,this.shader=null};