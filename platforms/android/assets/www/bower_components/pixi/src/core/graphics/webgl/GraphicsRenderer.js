function GraphicsRenderer(e){ObjectRenderer.call(this,e),this.graphicsDataPool=[],this.primitiveShader=null,this.complexPrimitiveShader=null,this.maximumSimplePolySize=200}var utils=require("../../utils"),math=require("../../math"),CONST=require("../../const"),ObjectRenderer=require("../../renderers/webgl/utils/ObjectRenderer"),WebGLRenderer=require("../../renderers/webgl/WebGLRenderer"),WebGLGraphicsData=require("./WebGLGraphicsData"),earcut=require("earcut");GraphicsRenderer.prototype=Object.create(ObjectRenderer.prototype),GraphicsRenderer.prototype.constructor=GraphicsRenderer,module.exports=GraphicsRenderer,WebGLRenderer.registerPlugin("graphics",GraphicsRenderer),GraphicsRenderer.prototype.onContextChange=function(){},GraphicsRenderer.prototype.destroy=function(){ObjectRenderer.prototype.destroy.call(this);for(var e=0;e<this.graphicsDataPool.length;++e)this.graphicsDataPool[e].destroy();this.graphicsDataPool=null},GraphicsRenderer.prototype.render=function(e){var t=this.renderer,n=t.gl,r=t.shaderManager.plugins.primitiveShader,i;e.dirty&&this.updateGraphics(e);var s=e._webGL[n.id];t.blendModeManager.setBlendMode(e.blendMode);for(var o=0,u=s.data.length;o<u;o++)i=s.data[o],s.data[o].mode===1?(t.stencilManager.pushStencil(e,i),n.uniform1f(t.shaderManager.complexPrimitiveShader.uniforms.alpha._location,e.worldAlpha*i.alpha),n.drawElements(n.TRIANGLE_FAN,4,n.UNSIGNED_SHORT,(i.indices.length-4)*2),t.stencilManager.popStencil(e,i)):(r=t.shaderManager.primitiveShader,t.shaderManager.setShader(r),n.uniformMatrix3fv(r.uniforms.translationMatrix._location,!1,e.worldTransform.toArray(!0)),n.uniformMatrix3fv(r.uniforms.projectionMatrix._location,!1,t.currentRenderTarget.projectionMatrix.toArray(!0)),n.uniform3fv(r.uniforms.tint._location,utils.hex2rgb(e.tint)),n.uniform1f(r.uniforms.alpha._location,e.worldAlpha),n.bindBuffer(n.ARRAY_BUFFER,i.buffer),n.vertexAttribPointer(r.attributes.aVertexPosition,2,n.FLOAT,!1,24,0),n.vertexAttribPointer(r.attributes.aColor,4,n.FLOAT,!1,24,8),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,i.indexBuffer),n.drawElements(n.TRIANGLE_STRIP,i.indices.length,n.UNSIGNED_SHORT,0)),t.drawCount++},GraphicsRenderer.prototype.updateGraphics=function(e){var t=this.renderer.gl,n=e._webGL[t.id];n||(n=e._webGL[t.id]={lastIndex:0,data:[],gl:t}),e.dirty=!1;var r;if(e.clearDirty){e.clearDirty=!1;for(r=0;r<n.data.length;r++){var i=n.data[r];i.reset(),this.graphicsDataPool.push(i)}n.data=[],n.lastIndex=0}var s;for(r=n.lastIndex;r<e.graphicsData.length;r++){var o=e.graphicsData[r];if(o.type===CONST.SHAPES.POLY){o.points=o.shape.points.slice(),o.shape.closed&&(o.points[0]!==o.points[o.points.length-2]||o.points[1]!==o.points[o.points.length-1])&&o.points.push(o.points[0],o.points[1]);if(o.fill&&o.points.length>=6)if(o.points.length<this.maximumSimplePolySize*2){s=this.switchMode(n,0);var u=this.buildPoly(o,s);u||(s=this.switchMode(n,1),this.buildComplexPoly(o,s))}else s=this.switchMode(n,1),this.buildComplexPoly(o,s);o.lineWidth>0&&(s=this.switchMode(n,0),this.buildLine(o,s))}else s=this.switchMode(n,0),o.type===CONST.SHAPES.RECT?this.buildRectangle(o,s):o.type===CONST.SHAPES.CIRC||o.type===CONST.SHAPES.ELIP?this.buildCircle(o,s):o.type===CONST.SHAPES.RREC&&this.buildRoundedRectangle(o,s);n.lastIndex++}for(r=0;r<n.data.length;r++)s=n.data[r],s.dirty&&s.upload()},GraphicsRenderer.prototype.switchMode=function(e,t){var n;if(!e.data.length)n=this.graphicsDataPool.pop()||new WebGLGraphicsData(e.gl),n.mode=t,e.data.push(n);else{n=e.data[e.data.length-1];if(n.points.length>32e4||n.mode!==t||t===1)n=this.graphicsDataPool.pop()||new WebGLGraphicsData(e.gl),n.mode=t,e.data.push(n)}return n.dirty=!0,n},GraphicsRenderer.prototype.buildRectangle=function(e,t){var n=e.shape,r=n.x,i=n.y,s=n.width,o=n.height;if(e.fill){var u=utils.hex2rgb(e.fillColor),a=e.fillAlpha,f=u[0]*a,l=u[1]*a,c=u[2]*a,h=t.points,p=t.indices,d=h.length/6;h.push(r,i),h.push(f,l,c,a),h.push(r+s,i),h.push(f,l,c,a),h.push(r,i+o),h.push(f,l,c,a),h.push(r+s,i+o),h.push(f,l,c,a),p.push(d,d,d+1,d+2,d+3,d+3)}if(e.lineWidth){var v=e.points;e.points=[r,i,r+s,i,r+s,i+o,r,i+o,r,i],this.buildLine(e,t),e.points=v}},GraphicsRenderer.prototype.buildRoundedRectangle=function(e,t){var n=e.shape,r=n.x,i=n.y,s=n.width,o=n.height,u=n.radius,a=[];a.push(r,i+u),this.quadraticBezierCurve(r,i+o-u,r,i+o,r+u,i+o,a),this.quadraticBezierCurve(r+s-u,i+o,r+s,i+o,r+s,i+o-u,a),this.quadraticBezierCurve(r+s,i+u,r+s,i,r+s-u,i,a),this.quadraticBezierCurve(r+u,i,r,i,r,i+u+1e-10,a);if(e.fill){var f=utils.hex2rgb(e.fillColor),l=e.fillAlpha,c=f[0]*l,h=f[1]*l,p=f[2]*l,d=t.points,v=t.indices,m=d.length/6,g=earcut(a,null,2),y=0;for(y=0;y<g.length;y+=3)v.push(g[y]+m),v.push(g[y]+m),v.push(g[y+1]+m),v.push(g[y+2]+m),v.push(g[y+2]+m);for(y=0;y<a.length;y++)d.push(a[y],a[++y],c,h,p,l)}if(e.lineWidth){var b=e.points;e.points=a,this.buildLine(e,t),e.points=b}},GraphicsRenderer.prototype.quadraticBezierCurve=function(e,t,n,r,i,s,o){function v(e,t,n){var r=t-e;return e+r*n}var u,a,f,l,c,h,p=20,d=o||[],m=0;for(var g=0;g<=p;g++)m=g/p,u=v(e,n,m),a=v(t,r,m),f=v(n,i,m),l=v(r,s,m),c=v(u,f,m),h=v(a,l,m),d.push(c,h);return d},GraphicsRenderer.prototype.buildCircle=function(e,t){var n=e.shape,r=n.x,i=n.y,s,o;e.type===CONST.SHAPES.CIRC?(s=n.radius,o=n.radius):(s=n.width,o=n.height);var u=Math.floor(30*Math.sqrt(n.radius))||Math.floor(15*Math.sqrt(n.width+n.height)),a=Math.PI*2/u,f=0;if(e.fill){var l=utils.hex2rgb(e.fillColor),c=e.fillAlpha,h=l[0]*c,p=l[1]*c,d=l[2]*c,v=t.points,m=t.indices,g=v.length/6;m.push(g);for(f=0;f<u+1;f++)v.push(r,i,h,p,d,c),v.push(r+Math.sin(a*f)*s,i+Math.cos(a*f)*o,h,p,d,c),m.push(g++,g++);m.push(g-1)}if(e.lineWidth){var y=e.points;e.points=[];for(f=0;f<u+1;f++)e.points.push(r+Math.sin(a*f)*s,i+Math.cos(a*f)*o);this.buildLine(e,t),e.points=y}},GraphicsRenderer.prototype.buildLine=function(e,t){var n=0,r=e.points;if(r.length===0)return;var i=new math.Point(r[0],r[1]),s=new math.Point(r[r.length-2],r[r.length-1]);if(i.x===s.x&&i.y===s.y){r=r.slice(),r.pop(),r.pop(),s=new math.Point(r[r.length-2],r[r.length-1]);var o=s.x+(i.x-s.x)*.5,u=s.y+(i.y-s.y)*.5;r.unshift(o,u),r.push(o,u)}var a=t.points,f=t.indices,l=r.length/2,c=r.length,h=a.length/6,p=e.lineWidth/2,d=utils.hex2rgb(e.lineColor),v=e.lineAlpha,m=d[0]*v,g=d[1]*v,y=d[2]*v,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R;E=r[0],S=r[1],x=r[2],T=r[3],k=-(S-T),L=E-x,R=Math.sqrt(k*k+L*L),k/=R,L/=R,k*=p,L*=p,a.push(E-k,S-L,m,g,y,v),a.push(E+k,S+L,m,g,y,v);for(n=1;n<l-1;n++){E=r[(n-1)*2],S=r[(n-1)*2+1],x=r[n*2],T=r[n*2+1],N=r[(n+1)*2],C=r[(n+1)*2+1],k=-(S-T),L=E-x,R=Math.sqrt(k*k+L*L),k/=R,L/=R,k*=p,L*=p,A=-(T-C),O=x-N,R=Math.sqrt(A*A+O*O),A/=R,O/=R,A*=p,O*=p,D=-L+S-(-L+T),P=-k+x-(-k+E),H=(-k+E)*(-L+T)-(-k+x)*(-L+S),B=-O+C-(-O+T),j=-A+x-(-A+N),F=(-A+N)*(-O+T)-(-A+x)*(-O+C),I=D*j-B*P;if(Math.abs(I)<.1){I+=10.1,a.push(x-k,T-L,m,g,y,v),a.push(x+k,T+L,m,g,y,v);continue}b=(P*F-j*H)/I,w=(B*H-D*F)/I,q=(b-x)*(b-x)+(w-T)+(w-T),q>19600?(M=k-A,_=L-O,R=Math.sqrt(M*M+_*_),M/=R,_/=R,M*=p,_*=p,a.push(x-M,T-_),a.push(m,g,y,v),a.push(x+M,T+_),a.push(m,g,y,v),a.push(x-M,T-_),a.push(m,g,y,v),c++):(a.push(b,w),a.push(m,g,y,v),a.push(x-(b-x),T-(w-T)),a.push(m,g,y,v))}E=r[(l-2)*2],S=r[(l-2)*2+1],x=r[(l-1)*2],T=r[(l-1)*2+1],k=-(S-T),L=E-x,R=Math.sqrt(k*k+L*L),k/=R,L/=R,k*=p,L*=p,a.push(x-k,T-L),a.push(m,g,y,v),a.push(x+k,T+L),a.push(m,g,y,v),f.push(h);for(n=0;n<c;n++)f.push(h++);f.push(h-1)},GraphicsRenderer.prototype.buildComplexPoly=function(e,t){var n=e.points.slice();if(n.length<6)return;var r=t.indices;t.points=n,t.alpha=e.fillAlpha,t.color=utils.hex2rgb(e.fillColor);var i=Infinity,s=-Infinity,o=Infinity,u=-Infinity,a,f;for(var l=0;l<n.length;l+=2)a=n[l],f=n[l+1],i=a<i?a:i,s=a>s?a:s,o=f<o?f:o,u=f>u?f:u;n.push(i,o,s,o,s,u,i,u);var c=n.length/2;for(l=0;l<c;l++)r.push(l)},GraphicsRenderer.prototype.buildPoly=function(e,t){var n=e.points;if(n.length<6)return;var r=t.points,i=t.indices,s=n.length/2,o=utils.hex2rgb(e.fillColor),u=e.fillAlpha,a=o[0]*u,f=o[1]*u,l=o[2]*u,c=earcut(n,null,2);if(!c)return!1;var h=r.length/6,p=0;for(p=0;p<c.length;p+=3)i.push(c[p]+h),i.push(c[p]+h),i.push(c[p+1]+h),i.push(c[p+2]+h),i.push(c[p+2]+h);for(p=0;p<s;p++)r.push(n[p*2],n[p*2+1],a,f,l,u);return!0};