var core=require("../core"),DisplayObject=core.DisplayObject,_tempMatrix=new core.Matrix;DisplayObject.prototype._cacheAsBitmap=!1,DisplayObject.prototype._originalRenderWebGL=null,DisplayObject.prototype._originalRenderCanvas=null,DisplayObject.prototype._originalUpdateTransform=null,DisplayObject.prototype._originalHitTest=null,DisplayObject.prototype._originalDestroy=null,DisplayObject.prototype._cachedSprite=null,Object.defineProperties(DisplayObject.prototype,{cacheAsBitmap:{get:function(){return this._cacheAsBitmap},set:function(e){if(this._cacheAsBitmap===e)return;this._cacheAsBitmap=e,e?(this._originalRenderWebGL=this.renderWebGL,this._originalRenderCanvas=this.renderCanvas,this._originalUpdateTransform=this.updateTransform,this._originalGetBounds=this.getBounds,this._originalDestroy=this.destroy,this._originalContainsPoint=this.containsPoint,this.renderWebGL=this._renderCachedWebGL,this.renderCanvas=this._renderCachedCanvas,this.destroy=this._cacheAsBitmapDestroy):(this._cachedSprite&&this._destroyCachedDisplayObject(),this.renderWebGL=this._originalRenderWebGL,this.renderCanvas=this._originalRenderCanvas,this.getBounds=this._originalGetBounds,this.destroy=this._originalDestroy,this.updateTransform=this._originalUpdateTransform,this.containsPoint=this._originalContainsPoint)}}}),DisplayObject.prototype._renderCachedWebGL=function(e){if(!this.visible||this.worldAlpha<=0||!this.renderable)return;this._initCachedDisplayObject(e),this._cachedSprite.worldAlpha=this.worldAlpha,e.setObjectRenderer(e.plugins.sprite),e.plugins.sprite.render(this._cachedSprite)},DisplayObject.prototype._initCachedDisplayObject=function(e){if(this._cachedSprite)return;e.currentRenderer.flush();var t=this.getLocalBounds().clone();if(this._filters){var n=this._filters[0].padding;t.x-=n,t.y-=n,t.width+=n*2,t.height+=n*2}var r=e.currentRenderTarget,i=e.filterManager.filterStack,s=new core.RenderTexture(e,t.width|0,t.height|0),o=_tempMatrix;o.tx=-t.x,o.ty=-t.y,this.renderWebGL=this._originalRenderWebGL,s.render(this,o,!0,!0),e.setRenderTarget(r),e.filterManager.filterStack=i,this.renderWebGL=this._renderCachedWebGL,this.updateTransform=this.displayObjectUpdateTransform,this.getBounds=this._getCachedBounds,this._cachedSprite=new core.Sprite(s),this._cachedSprite.worldTransform=this.worldTransform,this._cachedSprite.anchor.x=-(t.x/t.width),this._cachedSprite.anchor.y=-(t.y/t.height),this.updateTransform(),this.containsPoint=this._cachedSprite.containsPoint.bind(this._cachedSprite)},DisplayObject.prototype._renderCachedCanvas=function(e){if(!this.visible||this.worldAlpha<=0||!this.renderable)return;this._initCachedDisplayObjectCanvas(e),this._cachedSprite.worldAlpha=this.worldAlpha,this._cachedSprite.renderCanvas(e)},DisplayObject.prototype._initCachedDisplayObjectCanvas=function(e){if(this._cachedSprite)return;var t=this.getLocalBounds(),n=e.context,r=new core.RenderTexture(e,t.width|0,t.height|0),i=_tempMatrix;i.tx=-t.x,i.ty=-t.y,this.renderCanvas=this._originalRenderCanvas,r.render(this,i,!0),e.context=n,this.renderCanvas=this._renderCachedCanvas,this.updateTransform=this.displayObjectUpdateTransform,this.getBounds=this._getCachedBounds,this._cachedSprite=new core.Sprite(r),this._cachedSprite.worldTransform=this.worldTransform,this._cachedSprite.anchor.x=-(t.x/t.width),this._cachedSprite.anchor.y=-(t.y/t.height),this.updateTransform(),this.containsPoint=this._cachedSprite.containsPoint.bind(this._cachedSprite)},DisplayObject.prototype._getCachedBounds=function(){return this._cachedSprite._currentBounds=null,this._cachedSprite.getBounds()},DisplayObject.prototype._destroyCachedDisplayObject=function(){this._cachedSprite._texture.destroy(),this._cachedSprite=null},DisplayObject.prototype._cacheAsBitmapDestroy=function(){this.cacheAsBitmap=!1,this._originalDestroy()};