/*
 * GLContext is a part of HTML GL library describing rendering context
 * Copyright (c) 2015 pixelscommander.com
 * Distributed under MIT license
 * http://htmlgl.com
 * */

(function(e){HTMLGL=e.HTMLGL=e.HTMLGL||{},HTMLGL.JQ_PLUGIN_NAME="htmlgl",HTMLGL.CUSTOM_ELEMENT_TAG_NAME="html-gl",HTMLGL.READY_EVENT="htmlglReady",HTMLGL.context=undefined,HTMLGL.stage=undefined,HTMLGL.renderer=undefined,HTMLGL.elements=[],HTMLGL.pixelRatio=null,HTMLGL.oldPixelRatio=null,HTMLGL.enabled=!0,HTMLGL.scrollX=0,HTMLGL.scrollY=0;var t=function(){e.HTMLGL.context=this,this.createStage(),this.updateScrollPosition(),this.initListeners(),this.elementResolver=new e.HTMLGL.GLElementResolver(this),document.body?this.initViewer():document.addEventListener("DOMContentLoaded",this.initViewer.bind(this))},n=t.prototype;n.initViewer=function(){this.createViewer(),this.resizeViewer(),this.appendViewer()},n.createViewer=function(){e.HTMLGL.renderer=this.renderer=PIXI.autoDetectRenderer(0,0,{transparent:!0}),this.renderer.view.style.position="fixed",this.renderer.view.style.top="0px",this.renderer.view.style.left="0px",this.renderer.view.style["pointer-events"]="none",this.renderer.view.style.pointerEvents="none"},n.appendViewer=function(){document.body.appendChild(this.renderer.view),requestAnimationFrame(this.redrawStage.bind(this))},n.resizeViewer=function(){var t=this,n=e.innerWidth,r=e.innerHeight;HTMLGL.pixelRatio=window.devicePixelRatio||1,console.log(HTMLGL.pixelRatio),n*=HTMLGL.pixelRatio,r*=HTMLGL.pixelRatio,HTMLGL.pixelRatio!==HTMLGL.oldPixelRatio?(this.disable(),this.updateTextures().then(function(){t.updateScrollPosition(),t.updateElementsPositions();var i=1/HTMLGL.pixelRatio;t.renderer.view.style.transformOrigin="0 0",t.renderer.view.style.webkitTransformOrigin="0 0",t.renderer.view.style.transform="scaleX("+i+") scaleY("+i+")",t.renderer.view.style.webkitTransform="scaleX("+i+") scaleY("+i+")",t.renderer.resize(n,r),this.enable(),e.HTMLGL.renderer.render(e.HTMLGL.stage)})):(this.renderer.view.parentNode&&this.updateTextures(),this.updateElementsPositions(),this.markStageAsChanged()),HTMLGL.oldPixelRatio=HTMLGL.pixelRatio},n.initListeners=function(){e.addEventListener("scroll",this.updateScrollPosition.bind(this)),e.addEventListener("resize",e.HTMLGL.util.debounce(this.resizeViewer,500).bind(this)),e.addEventListener("resize",this.updateElementsPositions.bind(this)),document.addEventListener("click",this.onMouseEvent.bind(this),!0),document.addEventListener("mousemove",this.onMouseEvent.bind(this),!0),document.addEventListener("mouseup",this.onMouseEvent.bind(this),!0),document.addEventListener("mousedown",this.onMouseEvent.bind(this),!0),document.addEventListener("touchstart",this.onMouseEvent.bind(this)),document.addEventListener("touchend",this.onMouseEvent.bind(this))},n.updateScrollPosition=function(){var t={};if(window.pageYOffset!=undefined)t={left:pageXOffset,top:pageYOffset};else{var n,r,i=document,s=i.documentElement,o=i.body;n=s.scrollLeft||o.scrollLeft||0,r=s.scrollTop||o.scrollTop||0,t={left:n,top:r}}this.document.x=-t.left*HTMLGL.pixelRatio,this.document.y=-t.top*HTMLGL.pixelRatio,e.HTMLGL.scrollX=t.left,e.HTMLGL.scrollY=t.top,this.markStageAsChanged()},n.createStage=function(){e.HTMLGL.stage=this.stage=new PIXI.Stage(16777215),e.HTMLGL.document=this.document=new PIXI.DisplayObjectContainer,this.stage.addChild(e.HTMLGL.document)},n.redrawStage=function(){e.HTMLGL.stage.changed&&e.HTMLGL.renderer&&e.HTMLGL.enabled&&(e.HTMLGL.renderer.render(e.HTMLGL.stage),e.HTMLGL.stage.changed=!1)},n.updateTextures=function(){var t=[];return e.HTMLGL.elements.forEach(function(e){t.push(e.updateTexture())}),Promise.all(t)},n.initElements=function(){e.HTMLGL.elements.forEach(function(e){e.init()})},n.updateElementsPositions=function(){e.HTMLGL.elements.forEach(function(e){e.updateBoundingRect(),e.updatePivot(),e.updateSpriteTransform()})},n.onMouseEvent=function(t){var n=t.x||t.pageX,r=t.y||t.pageY,i=t.dispatcher!=="html-gl"?this.elementResolver.getElementByCoordinates(n,r):null;i?e.HTMLGL.util.emitEvent(i,t):null},n.markStageAsChanged=function(){e.HTMLGL.stage&&!e.HTMLGL.stage.changed&&(requestAnimationFrame(this.redrawStage),e.HTMLGL.stage.changed=!0)},n.disable=function(){e.HTMLGL.enabled=!0},n.enable=function(){e.HTMLGL.enabled=!1},e.HTMLGL.pixelRatio=window.devicePixelRatio||1,e.HTMLGL.GLContext=t,new t})(window);