<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">

<link rel="import" href="../bower_components/iron-menu-behavior/iron-menu-behavior.html">

<link rel="import" href="../bower_components/paper-fab-speed-dial/paper-fab-speed-dial-action.html">
<link rel="import" href="../bower_components/paper-fab-speed-dial/paper-fab-speed-dial.html">

<link rel="import" href="profile-img.html">
<link rel="import" href="swipeable-item.html">
<link rel="import" href="mail-thread.html">

<!--
A single GMail mail thread.

##### Example

    <mail-thread></mail-thread>
-->
<dom-module id="mail-messages">
  <style>
    :host {
      height: 100%;
      overflow: hidden;
    }

    #scroller {
      overflow: auto;
      height: 300px;
    }

    iron-list {

    }
  
    hidden {
      display: none;
    }

    mail-thread {
      width: 100%;
    }

    paper-spinner.blue {
      --paper-spinner-layer-1-color: var(--paper-light-blue-500);
      --paper-spinner-layer-2-color: var(--paper-light-blue-500);
      --paper-spinner-layer-3-color: var(--paper-light-blue-500);
      --paper-spinner-layer-4-color: var(--paper-light-blue-500);
    }

    #loading-area {
      margin-top: 20px;
      margin-bottom: 10px;
      margin-left: 50%;
    }

  </style>
  <template>
    
    <iron-scroll-threshold id="threshold" lower-threshold="1" on-lower-trigger="loadMore" lower-triggered="{{lowerTriggered}}" fit></iron-scroll-threshold> 

      <div id="scroller">
        <iron-selector id="threadlist" multi activate-event="thread-select"
                     selected-attribute="selected"
                     selected-items="{{selectedMessages}}"
                     on-iron-select="_onThreadSelectChange"
                     on-iron-deselect="_onThreadSelectChange">
          <template is="dom-repeat" items="{{items}}">
             <mail-thread folderid="{{item.folderID}}" msgid='{{item.msgID}}' subject="{{item.subject}}" from="{{item.from}}" date="{{item.date}}" bodyresume="{{item.bodyresume}}" route="{{item.route}}" on-open-message="openMessage" on-starred-message="starredMessage" data-thread-index$="{{item.index}}"></mail-thread>
          </template>
        </iron-selector>
        <div id='loading-area' class="layout flex center" hidden?="{{!lowerTriggered}}"><paper-spinner class="blue" alt="Carregando..." active></paper-spinner></div>
      </div>

      <!-- <paper-fab-speed-dial>
        <paper-fab-speed-dial-action icon="copy">Copy</paper-fab-speed-dial-action>
        <paper-fab-speed-dial-action icon="print">Print</paper-fab-speed-dial-action>
      </paper-fab-speed-dial> -->
      
  </template>
  <script>
  Polymer({
    is: 'mail-messages',

    ready: function() {
      this.$.threshold.scrollTarget = this.$.scroller;

      // console.log(Polymer.dom(this.$.scrollList));
      Polymer.dom(this.$.scroller).setAttribute('style', 'height: ' + (document.body.clientHeight - 56) + 'px;');

    },
    loadMore: function() {

      var scope = this;
      this.fire('load-next-page');
      scope.$.threshold.clearLower();
      //this.isLowerTriggered = false;

    },

    starredMessage: function(event) {
      var messageView = event.currentTarget;
      var msgid = messageView.get("msgid");
      var folderid = messageView.get("folderid");

      var starred = messageView.get("starred");

      this.currentMessage = {"msgid": msgid, "folderid": folderid, "starred": starred};

      this.fire('evt-starred-message', {thread: this});
    },

    _onThreadSelectChange: function(event) {
      console.log("_onThreadSelectChange");
      //console.log(this.selectedMessages);

      for (var thread in this.selectedMessages) {
        console.log(this.selectedMessages[thread].get('msgid'));
        // console.log("obj." + thread.get('msgid') + " = " + thread.get('folderid'));
      }

      this.fire('evt-select-messages', {thread: this});
    },

    getSelectedMessages: function() {
      var arrMessages = [];
       for (var thread in this.selectedMessages) {
        arrMessages.push({msgid: this.selectedMessages[thread].get('msgid'), folderid: this.selectedMessages[thread].get('folderid')});
      }
      return arrMessages;
    },

    openMessage: function(event) {

      var messageView = event.currentTarget;
      var msgid = messageView.get("msgid");
      var folderid = messageView.get("folderid");
      var route = messageView.get("route");

      this.currentMessage = {"msgid": msgid, "folderid": folderid, "route": route };

      this.fire('evt-open-message', {thread: this});

    },

    resize: function() {
      Polymer.dom(this.$.scroller).setAttribute('style', 'height: ' + (document.body.clientHeight - 56) + 'px;');
    },

    properties: {
      items: {
        type: Array, 
        value: []
      },
      selectedMessages: {
        type: Array, 
        reflectAttribute: true,
        value: []
      },

      currentMessage: {
        type: Array,
        value: []
      },
      isLowerTriggered: {
        type: Boolean,
        value: true,
      }
    }

    
  });
</script>
</dom-module>