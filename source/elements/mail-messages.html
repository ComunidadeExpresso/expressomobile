<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../bower_components/iron-menu-behavior/iron-menu-behavior.html">

<link rel="import" href="mail-folder.html">
<link rel="import" href="profile-img.html">
<link rel="import" href="swipeable-item.html">
<link rel="import" href="mail-thread.html">


<dom-module id="mail-messages">
  <style>
    :host {
      height: 100%;
      overflow: hidden;
    }

    iron-list {

    }
  
    hidden {
      display: none;
    }

    mail-thread {
      width: 100%;
    }

    paper-spinner.blue {
      --paper-spinner-layer-1-color: var(--paper-light-blue-500);
      --paper-spinner-layer-2-color: var(--paper-light-blue-500);
      --paper-spinner-layer-3-color: var(--paper-light-blue-500);
      --paper-spinner-layer-4-color: var(--paper-light-blue-500);
    }

    #loadingArea {
      margin-top: 20px;
      margin-bottom: 10px;
      margin-left: 50%;
    }

    #hasMoreMessagesArea {
      margin-top: 20px;
      margin-bottom: 20px;
      width: 100%;
      margin-left: 20px;

      text-align: center;
    }

  </style>
  <template>
      
      <iron-selector id="threadlist" multi activate-event="evt-selector-messages"
                       selected-attribute="selected"
                       selected-items="{{selectedMessages}}"
                       on-iron-select="_onThreadSelectorChange"
                       on-iron-deselect="_onThreadSelectorChange">

      <iron-list id="scrollList" items="{{items}}" as="item" on-scroll="onScroll">
      <template>
         <div>
        <template is="dom-if" if="[[item.isFolder]]">
          <mail-folder folder-name="{{item.folderName}}" folder-id="{{item.folderID}}" route="{{item.route}}" on-open-folder="_openFolder"></mail-folder>
        </template>
        <template is="dom-if" if="[[!item.isFolder]]">
          <iron-selector id="threadlist" multi activate-event="thread-select"
                       selected-attribute="selected"
                       selected-items="{{tempMessages}}"
                       on-iron-select="_onThreadSelectChange"
                       on-iron-deselect="_onThreadSelectChange">
           <mail-thread folderid="{{item.folderID}}" msgid='{{item.msgID}}' subject="{{item.subject}}" from="{{item.from}}" date="{{item.date}}" bodyresume="{{item.bodyresume}}" route="{{item.route}}" unread="{{item.unread}}" starred="{{item.starred}}" on-open-message="openMessage" on-starred-message="starredMessage" data-thread-index$="{{item.index}}"></mail-thread>
           </iron-selector>
        </template>
      </div>
      </template>
      </iron-list>

      </iron-selector>
    
    <div id='loadingArea' class="layout flex center" style$="[[_computeShowLoadingNextPageStyle(isLoadingNextPage)]]"><paper-spinner class="blue" alt="Carregando..." active></paper-spinner></div>

    <div id='hasMoreMessagesArea' class="layout flex center" style$="[[_computeShowMoreMessagesStyle(hasMoreMessages)]]">Esta pasta n&atilde;o cont&eacute;m mais mensagens...</div>

  </template>
  <script>
  Polymer({
    is: 'mail-messages',

    onScroll: function(e) {

      if ((this.hasMoreMessages) && (!this.isLoadingNextPage)) {

        if (e.target.scrollTop + e.target.offsetHeight >= e.target.scrollHeight - 500) {

          Polymer.dom(this.$.loadingArea).classList.remove('hidden');
          this.isLoadingNextPage = true;
          this.fire('lower-trigger');

        }
      }

    },

    addItems: function(nextPageItems) {

      //HAS FINISHED LOADING PAGES
      this.isLoadingNextPage = false;

      if (nextPageItems.length == 0) {
      
        this.hasMoreMessages = false;

      } else {

        var that = this;

        _.each(nextPageItems, function(message){ 
          that.push('items',message);
        });

      }

    },

    ready: function() {

      Polymer.dom(this.$.scrollList).setAttribute('style', 'height: ' + (document.body.clientHeight - 50) + 'px;');

    },


    starredMessage: function(event) {
      var messageView = event.currentTarget;
      var msgid = messageView.get("msgid");
      var folderid = messageView.get("folderid");

      var starred = messageView.get("starred");

      this.currentMessage = {"msgid": msgid, "folderid": folderid, "starred": starred};

      this.fire('evt-starred-message', {thread: this});
    },

    openMessage: function(event) {

      var messageView = event.currentTarget;
      var msgid = messageView.get("msgid");
      var folderid = messageView.get("folderid");
      var route = messageView.get("route");

      this.currentMessage = {"msgid": msgid, "folderid": folderid, "route": route };

      this.fire('evt-open-message', {thread: this});

    },

    _openFolder: function(event) {

      var folderView = event.currentTarget;

      var folderId = folderView.get("folderId");

      this.currentFolder = {"folderId": folderId};

      this.fire('evt-open-folder', {folder: this});

    },

    _onThreadSelectorChange: function(event) {
      console.log("_onThreadSelectorChange");
      //console.log(event);
      // console.log(event.detail.get('items'));

      for (var thread in this.selectedMessages) {
        //console.log(this.selectedMessages[thread].get('msgid'));
        // console.log("obj." + thread.get('msgid') + " = " + thread.get('folderid'));
      }

      this.fire('evt-select-messages', {thread: this});
    },

    _onThreadSelectChange: function(event) {

      var message = {};

      for (var thread in this.tempMessages) {

        msgID = this.tempMessages[thread].get('msgid');
        folderID = this.tempMessages[thread].get('folderid');
        message = { msgid: msgID, folderid: folderID, selected: true };
      }

      var found = false;
      var newArr = [];
      for (var thread in this.selectedMessages) {
        if (thread.msgid == message.msgid) {
          found = true;
        } else {
          newArr.push(thread);
        }
      }

      if (!found) {
        this.selectedMessages.push(message);
      } else {
        this.selectedMessages = newArr;
      }

      console.log(this.selectedMessages);

      // this.fire('evt-select-messages', {thread: this});

      this.fire('evt-selector-messages', {thread: message});
    },

    getSelectedMessages: function() {

      return this.selectedMessages;
      // var arrMessages = [];
      //  for (var thread in this.selectedMessages) {
      //   arrMessages.push({msgid: this.selectedMessages[thread].get('msgid'), folderid: this.selectedMessages[thread].get('folderid')});
      // }
      // return arrMessages;
    },

    _computeShowMoreMessagesStyle: function(hasMoreMessages) {
      if (!hasMoreMessages) {
        return '';
      } else {
        return 'display: none;';
      }
      
    },

    _computeShowLoadingNextPageStyle: function(isLoadingNextPage) {
      if (isLoadingNextPage) {
        return '';
      } else {
        return 'display: none;';
      }
      
    },

    resize: function() {
      Polymer.dom(this.$.scrollList).setAttribute('style', 'height: ' + (document.body.clientHeight - 50) + 'px;');
    },

    properties: {
      items: {
        type: Array, 
        value: [],
        reflectAttribute: true
      },


      tempMessages: {
        type: Array, 
        reflectAttribute: true,
        value: []
      },
      selectedMessages: {
        type: Array, 
        reflectAttribute: true,
        value: []
      },
      currentMessage: {
        type: Array,
        value: []
      },
      currentFolder: {
        type: Array,
        value: []
      },
      hasMoreMessages: {
        type: Number,
        value: true,
        reflectAttribute: true,
      },
      isLoadingNextPage: {
        type: Number,
        value: false,
        reflectAttribute: true,
      }
    }

    
  });
</script>
</dom-module>